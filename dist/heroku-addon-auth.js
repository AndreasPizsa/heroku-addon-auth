// Generated by CoffeeScript 1.8.0
(function() {
  module.exports = function(options) {
    var log, manifest, manifestName, path, restify;
    log = options.log, manifest = options.manifest;
    if (log == null) {
      log = console;
    }
    if (!manifest) {
      path = require('path');
      manifestName = path.dirname(require.main.filename) + path.sep + 'addon-manifest.json';
      log.info({
        filename: manifestName
      }, "Loading manifest file");
      manifest = require(manifestName);
      log.info({
        filename: manifestName,
        mainfest: manifest
      }, "Loading manifest file successful.");
    }
    restify = require('restify');
    return function(req, res, next) {
      var auth, errorMessage, reqLog, _ref, _ref1;
      reqLog = (_ref = req.log) != null ? _ref : log;
      if (!req.authorization) {
        path = require('path');
        errorMessage = "Authorization middleware must be use()d before " + (path.basename(module.filename, '.litcoffee')) + ", e.g. server.use(restify.authorizationParser()).";
        reqLog.error(errorMessage);
        return next(new restify.errors.InternalError(errorMessage));
      }
      auth = (_ref1 = req.authorization) != null ? _ref1.basic : void 0;
      if (!auth || auth.username !== manifest.id || auth.password !== manifest.api.password) {
        reqLog.error({
          auth: auth,
          manifest: {
            id: manifest.id,
            apiPassword: manifest.api.password
          }
        }, "Authentication failed");
        return next(new restify.errors.UnauthorizedError);
      }
      return next();
    };
  };

}).call(this);
